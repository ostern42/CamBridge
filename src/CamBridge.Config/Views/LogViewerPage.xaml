<!-- src\CamBridge.Config\Views\LogViewerPage.xaml -->
<!-- Version: 0.7.28 -->
<!-- Description: Enhanced Log Viewer with unified header, filters, tail functionality and multi-selection -->
<!-- CLEAN VERSION with correct structure! -->

<Page x:Class="CamBridge.Config.Views.LogViewerPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:ui="http://schemas.modernwpf.com/2019"
      xmlns:vm="clr-namespace:CamBridge.Config.ViewModels"
      Loaded="Page_Loaded"
      Unloaded="Page_Unloaded">

    <Page.Resources>
        <!-- Converters -->
        <BooleanToVisibilityConverter x:Key="BoolToVisibility"/>

        <!-- Log Entry Template -->
        <DataTemplate x:Key="LogEntryTemplate" DataType="{x:Type vm:LogEntry}">
            <Border BorderThickness="0" Padding="8,2">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="80"/>
                        <ColumnDefinition Width="Auto" MinWidth="50"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Timestamp -->
                    <TextBlock Grid.Column="0" 
                               Text="{Binding Timestamp, StringFormat={}{0:HH:mm:ss}}"
                               FontFamily="Consolas"
                               FontSize="12"
                               Opacity="0.7"/>

                    <!-- Level -->
                    <Border Grid.Column="1" 
                            CornerRadius="2"
                            Padding="6,1"
                            Margin="0,0,8,0"
                            HorizontalAlignment="Left">
                        <Border.Background>
                            <SolidColorBrush Color="{Binding LevelColor}" Opacity="0.2"/>
                        </Border.Background>
                        <TextBlock Text="{Binding LevelText}"
                                   Foreground="{Binding LevelColor}"
                                   FontFamily="Consolas"
                                   FontSize="12"
                                   FontWeight="Bold"/>
                    </Border>

                    <!-- Message -->
                    <TextBlock Grid.Column="2" 
                               Text="{Binding Message}"
                               FontFamily="Consolas"
                               FontSize="12"
                               TextWrapping="Wrap"/>
                </Grid>
            </Border>
        </DataTemplate>
    </Page.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Unified Header -->
        <Border Grid.Row="0" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}">
            <Grid Height="60">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Text="Log Viewer"
                           FontSize="24"
                           FontWeight="SemiBold"
                           VerticalAlignment="Center"
                           Margin="24,0,0,0"/>

                <StackPanel Grid.Column="1"
                            Orientation="Horizontal"
                            VerticalAlignment="Center"
                            Margin="0,0,24,0">

                    <CheckBox Content="Auto-scroll"
                              IsChecked="{Binding IsAutoScrollEnabled}"
                              VerticalAlignment="Center"
                              Margin="0,0,16,0"/>

                    <Button Command="{Binding ExportLogCommand}"
                            ToolTip="Export filtered log"
                            MinWidth="80"
                            Margin="0,0,8,0">
                        <StackPanel Orientation="Horizontal">
                            <ui:SymbolIcon Symbol="Save" Margin="0,0,6,0"/>
                            <TextBlock Text="Export"/>
                        </StackPanel>
                    </Button>

                    <Button Content="Clear"
                            Command="{Binding ClearLogCommand}"
                            MinWidth="80"
                            Margin="0,0,8,0"/>

                    <Button Content="Refresh"
                            Command="{Binding RefreshCommand}"
                            MinWidth="80"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Filter Bar -->
        <Border Grid.Row="1"
                Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                BorderThickness="0"
                Padding="16,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="250"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Pipeline Multi-Selection -->
                <TextBlock Text="Pipelines:"
                           VerticalAlignment="Center"
                           Margin="0,0,12,0"/>

                <ui:DropDownButton Grid.Column="1"
                                   HorizontalAlignment="Stretch"
                                   Margin="0,0,16,0">
                    <ui:DropDownButton.Content>
                        <TextBlock Text="{Binding SelectedPipelineCount, StringFormat={}{0} selected}"/>
                    </ui:DropDownButton.Content>
                    <ui:DropDownButton.Flyout>
                        <ui:Flyout Placement="Bottom">
                            <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                                    BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    MinWidth="250"
                                    MaxHeight="300">
                                <ScrollViewer VerticalScrollBarVisibility="Auto">
                                    <ItemsControl ItemsSource="{Binding PipelineSelections}" Margin="8">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <CheckBox Content="{Binding Name}"
                                                          IsChecked="{Binding IsSelected}"
                                                          Margin="0,2"/>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </Border>
                        </ui:Flyout>
                    </ui:DropDownButton.Flyout>
                </ui:DropDownButton>

                <!-- Search -->
                <TextBlock Grid.Column="2"
                           Text="Search:"
                           VerticalAlignment="Center"
                           Margin="0,0,12,0"/>

                <TextBox Grid.Column="3"
                         Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         ui:ControlHelper.PlaceholderText="Filter log entries..."
                         VerticalAlignment="Center"
                         Margin="0,0,16,0"/>

                <!-- Level Filters -->
                <ui:DropDownButton Grid.Column="4" HorizontalAlignment="Right">
                    <ui:DropDownButton.Content>
                        <TextBlock>
                            <TextBlock.Text>
                                <MultiBinding StringFormat="Levels ({0})">
                                    <Binding Path="SelectedLevelCount"/>
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </ui:DropDownButton.Content>
                    <ui:DropDownButton.Flyout>
                        <ui:Flyout Placement="Bottom">
                            <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                                    BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    MinWidth="150">
                                <StackPanel Margin="8">
                                    <CheckBox Content="Debug" IsChecked="{Binding ShowDebug}" Margin="0,2"/>
                                    <CheckBox Content="Info" IsChecked="{Binding ShowInformation}" Margin="0,2"/>
                                    <CheckBox Content="Warning" IsChecked="{Binding ShowWarning}" Foreground="#FFA500" Margin="0,2"/>
                                    <CheckBox Content="Error" IsChecked="{Binding ShowError}" Foreground="#FF0000" Margin="0,2"/>
                                    <CheckBox Content="Critical" IsChecked="{Binding ShowCritical}" Foreground="#FF0000" FontWeight="Bold" Margin="0,2"/>
                                </StackPanel>
                            </Border>
                        </ui:Flyout>
                    </ui:DropDownButton.Flyout>
                </ui:DropDownButton>
            </Grid>
        </Border>

        <!-- Log Content -->
        <Border Grid.Row="2"
                Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                BorderThickness="0"
                Margin="16">
            <Grid>
                <!-- Main Log ListBox -->
                <ListBox x:Name="LogListBox"
                         ItemsSource="{Binding FilteredCombinedEntries}"
                         ItemTemplate="{StaticResource LogEntryTemplate}"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                         ScrollViewer.CanContentScroll="True"
                         VirtualizingPanel.IsVirtualizing="True"
                         VirtualizingPanel.VirtualizationMode="Recycling"
                         BorderThickness="0"
                         Background="Transparent"
                         SelectionMode="Extended"
                         PreviewKeyDown="LogListBox_PreviewKeyDown">

                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="0"/>
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border Background="{TemplateBinding Background}"
                                                BorderBrush="{TemplateBinding BorderBrush}"
                                                BorderThickness="{TemplateBinding BorderThickness}">
                                            <ContentPresenter/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource SystemControlHighlightListAccentLowBrush}"/>
                                </Trigger>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource SystemControlHighlightListLowBrush}"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </ListBox.ItemContainerStyle>

                    <ListBox.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Copy Selected Lines" 
                                      Click="CopySelectedLines_Click"
                                      InputGestureText="Ctrl+C">
                                <MenuItem.Icon>
                                    <ui:SymbolIcon Symbol="Copy"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator/>
                            <MenuItem Header="Copy Messages Only" Click="CopySelectedMessages_Click"/>
                            <MenuItem Header="Copy as CSV" Click="CopySelectedAsCSV_Click"/>
                            <Separator/>
                            <MenuItem Header="Export Selected..." Click="ExportSelected_Click">
                                <MenuItem.Icon>
                                    <ui:SymbolIcon Symbol="Save"/>
                                </MenuItem.Icon>
                            </MenuItem>
                        </ContextMenu>
                    </ListBox.ContextMenu>
                </ListBox>

                <!-- Empty State -->
                <TextBlock Text="No log entries to display"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           FontSize="16"
                           Opacity="0.5"
                           Visibility="{Binding FilteredCombinedEntries.Count, Converter={StaticResource ZeroToVisibility}}"/>

                <!-- Loading Overlay -->
                <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                        Opacity="0.9"
                        Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibility}}">
                    <StackPanel VerticalAlignment="Center"
                                HorizontalAlignment="Center">
                        <ui:ProgressRing IsActive="True"
                                         Width="48"
                                         Height="48"/>
                        <TextBlock Text="Loading log files..."
                                   Margin="0,16,0,0"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Border Grid.Row="3"
                Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                Height="28">
            <Grid Margin="16,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                           VerticalAlignment="Center"
                           FontSize="11"
                           Opacity="0.8">
                    <Run Text="Log files: "/>
                    <Run Text="{Binding CurrentLogFiles}" FontFamily="Consolas"/>
                </TextBlock>

                <TextBlock Grid.Column="1"
                           VerticalAlignment="Center"
                           FontSize="11"
                           Opacity="0.8"
                           Margin="0,0,8,0">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Text" Value="{Binding ElementName=LogListBox, Path=SelectedItems.Count, StringFormat={}{0} selected}"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding ElementName=LogListBox, Path=SelectedItems.Count}" Value="0">
                                    <Setter Property="Text" Value="{Binding DisplayedLineCount, StringFormat={}Showing {0}}"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>

                <TextBlock Grid.Column="2"
                           Text="{Binding TotalLineCount, StringFormat={}of {0} lines}"
                           VerticalAlignment="Center"
                           FontSize="11"
                           Opacity="0.8"
                           Margin="0,0,16,0"/>

                <TextBlock Grid.Column="3"
                           Text="{Binding LastUpdateTime, StringFormat={}Last update: {0:HH:mm:ss}}"
                           VerticalAlignment="Center"
                           FontSize="11"
                           Opacity="0.8"/>
            </Grid>
        </Border>
    </Grid>
</Page>
